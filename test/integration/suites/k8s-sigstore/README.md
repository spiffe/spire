# Kubernetes Sigstore Suite

## Description

This suite sets up a Kubernetes cluster using [Kind](https://kind.sigs.k8s.io) and tests SPIRE's Sigstore workload attestation capabilities.

The suite validates:

* SPIRE Server attests SPIRE agents by verifying Kubernetes Projected Service Account Tokens (i.e. `k8s_psat`) via the Token Review API.
* Workloads using signed and unsigned container images are correctly attested based on their Sigstore signatures.
* The k8s workload attestor generates appropriate selectors for:
  * Signed images with valid subjects
  * Signed images with wrong subjects (should not match)
  * Unsigned images (should not generate signature-related selectors)
  * Images in the skip list (should skip signature verification)
  * Multiple containers in a single pod

## Test Coverage

The integration tests verify the following scenarios:

1. **Single container workloads**:
   * Signed image with matching subject
   * Unsigned image
   * Signed image with wrong subject
   * Signed image with extra selectors (log-id, integrated-time, etc.)

2. **Multiple container pods**:
   * Multiple signed containers
   * Multiple unsigned containers
   * Mix of signed and unsigned containers
   * Signed containers with different subjects
   * Containers in skip list

3. **Caching**:
   * Verification that sigstore validation results are cached properly

## Sigstore Selectors

The following selectors can be generated by the k8s workload attestor when sigstore is enabled:

* `k8s:image-signature:verified` - When signature verification succeeds
* `k8s:image-attestations:verified` - When attestation verification succeeds (not used in these tests due to `ignore_attestations = true`)
* `k8s:image-signature-value` - The signature value
* `k8s:image-signature-subject` - The OIDC subject that signed the image
* `k8s:image-signature-issuer` - The OIDC issuer
* `k8s:image-signature-log-id` - The Rekor transparency log ID
* `k8s:image-signature-log-index` - The Rekor log index
* `k8s:image-signature-integrated-time` - The integration timestamp in Unix epoch format
* `k8s:image-signature-signed-entry-timestamp` - The signed entry timestamp from Rekor

## Requirements

* Docker
* kind
* kubectl
* Access to gcr.io for pulling cosign and crane images
* Access to public Rekor instance (<https://rekor.sigstore.dev>)

**Note**: This test suite shares Kubernetes version configuration with the base `k8s` suite via `../k8s/integration_k8s_versions.txt` and `../k8s/integration_k8s_min_version.txt`.

## Testing Approach

This test suite validates Sigstore functionality without requiring image signing during test execution. The approach:

### Pre-signed Test Images

The test uses official container images from public registries:

* `ghcr.io/spiffe/spire-agent:1.14.0` - Official SPIRE release signed by GitHub Actions with Sigstore
  * Subject: `https://github.com/spiffe/spire/.github/workflows/release_build.yaml@refs/tags/v1.14.0`
  * Issuer: `https://token.actions.githubusercontent.com`
  * Used for: Signed workload containers (`:signed` tag)
  * Copied with `cosign copy` to preserve signatures
* `ghcr.io/spiffe/spire-agent:1.13.0` - Recent SPIRE release (different digest from 1.14.0)
  * Used for: Unsigned/skiplist workload containers (`:unsigned`, `:unsigned-skiplist*`, `:signed-wrong-subject` tags)
  * Copied with `crane copy` (signatures not copied, though 1.13.0 is also signed)
  * Using a different version ensures distinct digests, allowing skiplist to properly distinguish between signed and unsigned variants

The SPIRE project signs all release images using Cosign during the GitHub Actions release workflow. Signatures are stored in:

1. **OCI Registry** - As `.sig` artifacts alongside the images
2. **Rekor Transparency Log** - Public log at <https://rekor.sigstore.dev>

### Local Registry Setup

The test creates a local Docker registry (`docker-registry-local:5001`) with self-signed TLS certificates to simulate a production environment. Images are copied from the public registry to the local registry using:

* **`cosign copy`** for signed images - Preserves both the image AND its signature artifacts (used for `:signed`)
* **`crane copy`** for unsigned/skiplist testing - Copies the image without signatures (used for `:unsigned`, `:unsigned-skiplist*`, `:signed-wrong-subject`)
  * These images use SPIRE agent 1.13.0 which has a different digest from the signed 1.14.0 image
  * Different digests allow the skiplist to properly distinguish and skip verification for these variants

### Signature Verification Flow

When SPIRE's k8s workload attestor processes a workload container:

1. **Fetches the image signature** from the OCI registry (`.sig` artifact)
2. **Verifies the signature** using the public key from the signing certificate
3. **Checks Rekor transparency log** to ensure the signature was recorded
4. **Validates the identity** against configured `allowed_identities`
5. **Emits selectors** with signature information (subject, issuer, log details)

### Test Isolation

* All tests run in an isolated Kind cluster with no external dependencies except:
  * Initial image downloads from public registries
  * Rekor transparency log verification (read-only)
* No image pushing or signing is performed during test execution
* Tests are fully repeatable using the same pre-signed images

### Handling Verification Failures

The current SPIRE implementation makes signature verification failures **fatal** - if verification fails, the entire workload attestation fails with empty selectors. To test scenarios like unsigned images or wrong subjects:

* Images that should fail verification are added to the `skipped_images` configuration
* This allows them to bypass Sigstore verification and receive standard k8s selectors
* Registration entries are created without signature-related selectors for these workloads

## Configuration

The test uses:

* A local Docker registry with self-signed certificates (`docker-registry-local:5001`)
* Official SPIRE release images signed by GitHub Actions
* SPIRE agent configured with sigstore experimental feature:
  * `allowed_identities`: `https://token.actions.githubusercontent.com` with subject `https://github.com/spiffe/spire/.github/workflows/release_build.yaml@refs/tags/v1.14.0`
  * `rekor_url`: `https://rekor.sigstore.dev/`
  * `ignore_sct`: `true` (skips Signed Certificate Timestamp verification)
  * `ignore_attestations`: `true` (skips attestation verification, only verifies signatures)
  * `skipped_images`: List of image digests that bypass Sigstore verification entirely (the unsigned workload digest from 1.13.0, and the agent image itself)
