

#Overview

Follow these walkthrough to set up your docker development environment and expose the Workload API. A workload client cmdline simulates a workload fetching SVIDs for its registered SPIFFE IDs.
 
 ![cache manager flow](images/SPIRE101.png)

###Requirement(s)

####GitHub Setup

Clone the SPIRE github repo:

    `git clone https://github.com/spiffe/spire`

Note: If you don’t already have a GitHub account, please get setup here.

####Docker Setup

Pull the latest SPIRE image from spiffe/spire-dev docker repository:

    `docker pull spiffe/spire-dev`
Note: If you don't already have Docker already installed, please follow these installation instructions.

###Terminology

 |Term                   | Description                                                      |
 |-----------------------|------------------------------------------------------------------|
 |spire-server           |  SPIRE server executable                                         |
 |spire-agent            |  SPIRE agent executable                                          |
 |wlcli                  |  Workload API GRPC client executable                             |
 |socketPath             |  Unix Domain Socket file path through which workloads            |
 |                       |  connects to Workload API                                        |                                          
 |joinToken              |  Nonce generated by the SPIRE server to attest SPIRE agents      |


###Walkthrough

Setup your local Docker development environment, cd to the directory you cloned the SPIRE repo into and start the container 

    cd ~/spire
    docker-compose up -d

Connect to the spire-dev container you just started 
	
    docker-compose exec spire-dev bash

Create a user with uid 1000 for workload attestation
	
	useradd -u 1000 workload

Install external dependencies by running
	
	make vendor

The build target builds spire-server, spire-agent and wlcli executable, it also builds the plugin binaries.
    
    make build

The `spire-server` and `spire-agent` executables along with their respective subcommands have a `—help`  option that give more details on using the specific cli options. Try running help for register sub command:
	
	./cmd/spire-server/spire-server register --help

Familiarize with the server config
	
	cat conf/server/server.conf

Start the spire-server in background by running the command:

    ./cmd/spire-server/spire-server run &

Generate a join token and create a vanity spiffeID: spiffe://example.org/host
	
	./cmd/spire-server/spire-server token generate -spiffeID spiffe://example.org/host

Familiarize with the agent config
	
	cat conf/agent/agent.conf

Start the spire-agent in the background 

    ./cmd/spire-agent/spire-agent run -joinToken <generated-join-token> &

Register workload spiffeID with unix type and uid:
   	
   	./cmd/spire-server/spire-server register -parentID spiffe://example.org/host -spiffeID spiffe://example.org/host/workload selector unix:uid:1000

Run the grpc workload client as user workload with uid 1000
    
    su -c ./cmd/wlcli/wlcli fetchsvid

Print out the generated SVID. Show the SAN SPIFFE ID URI 
	
	openssl x509 -inform der -in 0.svid -text -noout

