

## Overview

This walkthrough will guide you through the steps needed to setup a running example of a SPIRE server and agent. Interaction with the [Workload API](../proto/api/workload/workload.proto) will be simulated via a command line tool.

 ![SPIRE101](images/spire101.png) 

## Requirement(s)

### GitHub Setup

Create a directory spire-walkthrough and clone the SPIRE github repo inside it.

    mkdir ~/spire-walkthrough
    cd ~/spire-walkthrough
    git clone https://github.com/spiffe/spire
        
Note: If you don’t already have a GitHub account, please get setup [here](https://github.com).

### Docker Setup

Pull the latest image from the docker repository hosted in the public repo **spiffe/spire-dev**

    docker pull spiffe/spire-dev
    
Note: If you don't already have Docker installed, please follow these [installation instructions](https://docs.docker.com/engine/installation/).

## Terminology

 |Term                   | Description                                                      |
 |-----------------------|------------------------------------------------------------------|
 |spire-server           |  SPIRE server executable                                         |
 |spire-agent            |  SPIRE agent executable                                          |
 |wlcli                  |  Workload API GRPC client executable                             |
 |socketPath             |  Unix Domain Socket file path through which workloads            |
 |                       |  connects to Workload API                                        |                                          
 |joinToken              |  Nonce generated by the SPIRE server to attest SPIRE agents      |


## Walkthrough

1.  Setup your local Docker development environment, cd to the directory you cloned the SPIRE repo into and start the container.

        cd ~/spire-walkthrough/spire
        docker-compose up -d
    
2.  Check to make sure the spire-dev docker container is running. 

        docker ps |grep spire-dev

3.  Get an interactive bash prompt to the running spire-dev container.
	
        docker-compose exec spire-dev bash

4.  Create a user with uid 1000. The uid will be registered as a selector of the workload SPIFFEID. During kernel based attestation the workload process will be interogated for the registered uid.
	
	    useradd -u 1000 workload

5.  Install external dependencies of SPIRE by running the **vendor** target.
	
	    make vendor

6.  Build SPIRE by running the **build** target. The build target builds spire-server, spire-agent and wlcli executable, it also builds the plugin binaries.
    
        make build

7.  Try running help for register sub command. The **spire-server** and **spire-agent** executables have `-—help`  option that give details of respective cli options. 
	
	    ./cmd/spire-server/spire-server register --help

8.  View the server configuration file.
    	 
    	    cat conf/server/server.conf
    
    The default server configurations are shown below. A detailed description of each of the server configuration option is [here](/README.md#spire-server-configuration)
    
    ```
    BaseSVIDTTL = 999999
    ServerSVIDTTL = 999999
    BindAddress = "127.0.0.1"
    BindPort = "8081"
    BindHTTPPort = "8080"
    LogLevel = "INFO"
    PluginDir = "conf/server/plugin"
    TrustDomain = "example.org"
    Umask = ""
    ```

9.  Start the spire-server as a background process by running the following command.

        ./cmd/spire-server/spire-server run &

10. Generate a one time join token via **spire-server token generate** sub commmand. Use the **-spiffeID** option to associate the join token with **spiffe://example.org/host** Spiffe ID. Save the genreated join token in your copy buffer.
	
	    ./cmd/spire-server/spire-server token generate -spiffeID spiffe://example.org/host
	    
	 The join token will be used for node attestation and the associated spiffeID will be used to generate the SVID of the attested node. 
	 
	 The join tokens have a default ttl value of 600 seconds which is configurable through **-ttl** option.

11. View the configuration file of the agent
    	
        cat conf/agent/agent.conf
    
    The default agent configurations are shown below. A detailed description of each of the agent configuration option is [here](/README.md#spire-agent-configuration)
    ```
    BindAddress = "127.0.0.1"
    BindPort = "8088"
    DataDir = "."
    LogLevel = "INFO"
    PluginDir = "conf/agent/plugin"
    ServerAddress = "127.0.0.1"
    ServerPort = "8081"
    SocketPath ="/tmp/agent.sock"
    TrustBundlePath = "conf/agent/carootcert.pem"
    TrustDomain = "example.org"
    Umask = ""
    ```

12. Start the spire-agent as a background process by replacing **_<generated-join-token>_** with the generated join token in step #10 and running the following command.

        ./cmd/spire-agent/spire-agent run -joinToken <generated-join-token> &

13. The next step is to register a Spiffe ID with a set of selectors. For the example we will use unix kernel selectors that will be mapped to a target SPIFFE ID.
   	
        ./cmd/spire-server/spire-server register -parentID spiffe://example.org/host -spiffeID spiffe://example.org/host/workload -selector unix:uid:1000
    At this point, the registration API has been called and the target workload has been registered with the SPIRE Server. We can now call the workload API using a command line program to request a new SVID from the SPIRE server.

14. Simulate the workload API interaction and retrieve the workload SVID bundle by running the wlcli commandline program. Run wlcli as user **_workload_** created in step #4 with uid 1000
    
        su -c "./cmd/wlcli/wlcli fetchsvid -socketPath /tmp/agent.sock" workload

15. Examine the generated SVID. Verify that the SAN URI matches the registered spiffeID for the workload
	
	    openssl x509 -inform der -in ~/go/src/github.com/spiffe/spire/0.svid -text -noout

